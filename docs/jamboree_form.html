<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MG Jamboree 2025: Cars in Paradise Registration</title>
  <!-- Load the PayPal JS SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=AV3tPHQiTdXFl-AMQq_6Kd_5VvfnKOzSeMp1OCHfKafXBT_oQurHU_zhzrctGnIhCJOYoI-B40hYdvqw&currency=USD"></script>
  <!-- Load secrets configuration -->
  <script src="secrets.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    
    #paymentForm {
      padding: 30px;
    }
    
    label {
      display: block;
      margin-bottom: 15px;
      font-weight: bold;
      color: #333;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
      margin-top: 5px;
    }
    
    input:focus, textarea:focus, select:focus {
      border-color: #4CAF50;
      outline: none;
    }
    
    #paypal-button-container {
      transition: opacity 0.3s ease;
      width: 100%;
      margin-top: 20px;
    }
    
    .form-validation-message {
      color: #d32f2f;
      font-size: 14px;
      margin-bottom: 10px;
      display: none;
      text-align: center;
      padding: 10px;
      border-radius: 5px;
      border-left: 4px solid #d32f2f;
    }
    
    .form-validation-message.show {
      display: block;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .loading-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    p {
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #ff9800;
      line-height: 1.6;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <h1>MG Jamboree 2025 Registration</h1>
  
  <form id="paymentForm">
    <label>
      First Name:
      <input type="text" id="firstName" name="firstName" required>
    </label>

    <label>
      Last Name:
      <input type="text" id="lastName" name="lastName" required>
    </label>

    <label>
      Other Attendees (if applicable):
      <textarea id="attendees" name="attendees" rows="2" placeholder="First & Last Name"></textarea>
    </label>

    <label>
      Address:
      <textarea id="address" name="address" rows="4" placeholder="Street, City, State ZIP" required></textarea>
    </label>

    <label>
      Phone Number:
      <input type="tel" id="phone" name="phone" required>
    </label>

    <label>
      Email Address:
      <input type="email" id="email" name="email" required>
    </label>
    
    <label>
      Year, Make, and Model:
      <input type="text" id="yearMakeModel" name="yearMakeModel" placeholder="e.g., 1965 MGB">
    </label>

    <p><strong>LIABILITY RELEASE:</strong><br>
    I AM AWARE of the hazards inherent with motor vehicle events & specifically release & so indemnify the organizers, supporting sponsors, & the Florida Suncoast MG Car Club collectively & separately, for any & all liability from personal injury or property damage incurred by me or my guest(s) while participating in the MG Jamboree. I understand & agree that The Florida Suncoast MG Car Club reserves the right to revoke my registration & retain my registration fee should I engage in reckless, dangerous and/or unsafe behavior. I (We) have read, understand, and agree to this release.</p>

    <label>
      Digital Signature (Type Your Full Name):
      <textarea id="signature" name="signature" rows="2" placeholder="Your typed name" required></textarea>
    </label>

    <label>
      Registration Type:
      <select id="eventType" name="eventType">
        <option value="carShow">MG Jamboree 2025 Registration Only</option>
        <option value="boatTour">MG Jamboree and Pontoon Boat Tour</option>
      </select>
    </label>

    <label id="participantsLabel" style="display:none;">
      Number of Participants for Pontoon Tour:
      <input type="number" id="participants" name="participants" min="1" value="1">
    </label>

    <label>
      Amount (USD):
      <input type="number" id="amount" name="amount" step="0.01" min="0.01" readonly>
    </label>
    
    <div id="validation-message" class="form-validation-message">
      Please fill out all required fields before proceeding with payment.
    </div>
    <!-- The PayPal button will render here -->
    <div id="paypal-button-container"></div>
  </form>

  <script>
    // Server configuration
    const SERVER_URL = 'https://lbdbikz3d1.execute-api.us-east-1.amazonaws.com/v1/register';
    
    // Function to collect all form data
    function collectFormData() {
      return {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        attendees: document.getElementById('attendees').value.trim(),
        address: document.getElementById('address').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        email: document.getElementById('email').value.trim(),
        yearMakeModel: document.getElementById('yearMakeModel').value.trim(),
        signature: document.getElementById('signature').value.trim(),
        eventType: document.getElementById('eventType').value,
        participants: document.getElementById('participants').value,
        amount: document.getElementById('amount').value,
        timestamp: new Date().toISOString(),
        paymentStatus: 'pending'
      };
    }

    // Function to send registration data to server
    async function sendToServer(formData, paymentDetails = null) {
      try {
        const apiKey = window.SecretsConfig?.getApiKey();
        if (!apiKey) {
          console.error('API key not configured');
          throw new Error('API key configuration error');
        }

        const requestData = {
          ...formData,
          paymentDetails: paymentDetails
        };

        const response = await fetch(SERVER_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey
          },
          body: JSON.stringify(requestData)
        });

        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Successfully sent to server:', result);
        return result;
      } catch (error) {
        console.error('Error sending to server:', error);
        throw error;
      }
    }

    function updateAmount() {
      var eventType = document.getElementById('eventType').value;
      var now = new Date();
      var cutoffCar = new Date('2025-09-01');
      var registrationFee = 0;
      var pontoonFee = 0;
      
      // Registration fee is always required
      registrationFee = now < cutoffCar ? 25 : 35;
      
      if (eventType === 'carShow') {
        // Car show only - just registration fee
        document.getElementById('participantsLabel').style.display = 'none';
        pontoonFee = 0;
      } else if (eventType === 'boatTour') {
        // Pontoon boat tour - registration fee plus pontoon fee
        var participants = parseInt(document.getElementById('participants').value) || 1;
        pontoonFee = participants * 25;
        document.getElementById('participantsLabel').style.display = 'block';
      }
      
      var totalAmount = registrationFee + pontoonFee;
      // Add 5% processing fee
      totalAmount = totalAmount * 1.05;
      document.getElementById('amount').value = totalAmount.toFixed(2);
      
      // Check form validation after amount update
      checkFormValidity();
    }

    function validateForm() {
      var firstName = document.getElementById('firstName').value.trim();
      var lastName = document.getElementById('lastName').value.trim();
      var address = document.getElementById('address').value.trim();
      var phone = document.getElementById('phone').value.trim();
      var email = document.getElementById('email').value.trim();
      var signature = document.getElementById('signature').value.trim();

      return firstName && lastName && address && phone && email && signature;
    }

    function checkFormValidity() {
      var paypalContainer = document.getElementById('paypal-button-container');
      var validationMessage = document.getElementById('validation-message');
      var isValid = validateForm();
      
      if (isValid) {
        paypalContainer.style.opacity = '1';
        paypalContainer.style.pointerEvents = 'auto';
        validationMessage.classList.remove('show');
      } else {
        paypalContainer.style.opacity = '0.5';
        paypalContainer.style.pointerEvents = 'none';
        validationMessage.classList.add('show');
      }
    }

    // Add event listeners to all required fields for real-time validation
    document.getElementById('firstName').addEventListener('input', checkFormValidity);
    document.getElementById('lastName').addEventListener('input', checkFormValidity);
    document.getElementById('address').addEventListener('input', checkFormValidity);
    document.getElementById('phone').addEventListener('input', checkFormValidity);
    document.getElementById('email').addEventListener('input', checkFormValidity);
    document.getElementById('signature').addEventListener('input', checkFormValidity);

    document.getElementById('eventType').addEventListener('change', updateAmount);
    document.getElementById('participants').addEventListener('input', updateAmount);
    window.addEventListener('load', function() {
      updateAmount();
      checkFormValidity();
    });

    // Wait until the SDK is loaded
    paypal.Buttons({

      // Called when the user clicks the button
      createOrder: function(data, actions) {
        // Double-check form validation before processing payment
        if (!validateForm()) {
          alert('Please fill out all required fields before proceeding with payment.');
          return Promise.reject(new Error('Form validation failed'));
        }
        
        var amt = parseFloat(document.getElementById('amount').value).toFixed(2);
        return actions.order.create({
          purchase_units: [{
            amount: { value: amt }
          }]
        });
      },

      // Called after the payment is approved
      onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
          // Collect form data
          const formData = collectFormData();
          formData.paymentStatus = 'completed';
          
          // Add PayPal payment details
          const paymentDetails = {
            paypalOrderId: data.orderID,
            paypalPayerId: data.payerID,
            paypalPaymentId: details.id,
            payerName: details.payer?.name?.given_name + ' ' + details.payer?.name?.surname,
            payerEmail: details.payer?.email_address,
            amount: details.purchase_units[0]?.amount?.value,
            currency: details.purchase_units[0]?.amount?.currency_code,
            captureTime: details.create_time
          };

          // Send registration data to server
          sendToServer(formData, paymentDetails)
            .then(function(serverResponse) {
              console.log('Registration successfully submitted:', serverResponse);
              
              // Redirect to thank-you page 
              // alert('Registration completed successfully! You will receive a confirmation email shortly.');
              window.location.href = 'https://www.fsmgcc.com/mg-jamboree-registration';
            })
            .catch(function(error) {
              console.error('Failed to submit registration:', error);
              // Even if server call fails, payment was successful
              alert('Payment completed successfully, but there was an issue submitting your registration. Please contact us with your payment confirmation.');
            });
        });
      },

      // Optional: handle cancellations or errors
      onCancel: function (data) {
        alert('Payment cancelled.');
      },
      onError: function (err) {
        console.error('PayPal error', err);
        alert('Something went wrong—you can try again.');
      }

    }).render('#paypal-button-container');
  </script>

</body>
</html>